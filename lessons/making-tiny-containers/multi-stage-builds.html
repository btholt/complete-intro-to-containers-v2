<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"/><link rel="icon" type="image/x-icon" href="/images/favicon.ico"/><title>Multi Stage Builds – Complete Intro to Containers</title><meta name="description" content="Learn how to optimize Docker images using multistage builds with Node.js and Alpine, reducing container size significantly by eliminating unnecessary dependencies like npm. Follow a tutorial on building a Dockerfile with multiple stages and leveraging Alpine for smaller, more efficient containers."/><meta name="keywords" content="Docker multistage build,Node.js Alpine Docker image,optimize Docker image size"/><meta name="og:description" content="Learn how to optimize Docker images using multistage builds with Node.js and Alpine, reducing container size significantly by eliminating unnecessary dependencies like npm. Follow a tutorial on building a Dockerfile with multiple stages and leveraging Alpine for smaller, more efficient containers."/><meta name="og:title" content="Multi Stage Builds – Complete Intro to Containers"/><meta name="og:image" content="/images/social-share-cover.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="next-head-count" content="14"/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/cfac17cb37b27821.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/cfac17cb37b27821.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-4e7214a60fad8e88.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-d2ba44903cd47711.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-564cf6bb10408614.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-ba225542c35827e2.js" defer="" crossorigin=""></script><script src="/_next/static/nARcRKX1ZlcrYUdSUSS9z/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/nARcRKX1ZlcrYUdSUSS9z/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Complete Intro to Containers</a></h1><div class="navbar-info"><a href="https://holt.fyi/containers" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>Hey, we&#39;re already half-way to ridiculous, let&#39;s make our image EVEN SMALLER. Technically we only need <code>npm</code> to build our app, right? We don&#39;t actually need it to run our app. Docker allows you to have what it called multistage builds, we it uses one container to build your app and another to run it. This can be useful if you have big dependencies to build your app but you don&#39;t need those dependencies to actually run the app. A C++ or Rust app might be a good example of that: they need big tool chains to compile the apps but the resulting binaries are smaller and don&#39;t need those tools to actually run them. Or one perhaps more applicable to you is that you don&#39;t need the TypeScript or Sass compiler in production, just the compiled files. We&#39;ll actually do that here in a sec, but let&#39;s start here with eliminating <code>npm</code>.</p>
<p>Make a new Dockerfile, call it <code>Dockerfile</code>.</p>
<pre><code class="hljs language-dockerfile"><span class="hljs-comment"># build stage</span>
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">20</span> AS node-builder
<span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /build</span>
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /build</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> package-lock.json package.json ./</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> npm ci</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>

<span class="hljs-comment"># runtime stage</span>
<span class="hljs-keyword">FROM</span> alpine:<span class="hljs-number">3.19</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> apk add --update nodejs</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> addgroup -S node &amp;&amp; adduser -S node -G node</span>
<span class="hljs-keyword">USER</span> node
<span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/node/code</span>
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /home/node/code</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=node-builder --<span class="hljs-built_in">chown</span>=node:node /build .</span>
<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;index.js&quot;</span>]</span>
</code></pre><p>Notice we have have two <code>FROM</code> instructions. This is how you can tell it&#39;s multistage. The last container made will be the final one that gets labeled and shipped. Notice we&#39;re starting in the full <code>node:20</code> container since we&#39;re not going to ship this container so we can use the kitchen sink to build it before it copying it to a smaller container.</p>
<p>After building everything in the build stage (you can have more than two stages by the way) we move on to the runtime container. In this one we&#39;re using Alpine due its size and security benefits. Everything else looks similar to what we were doing before, just now we&#39;re going to be copying from the build container instead of the host machine.</p>
<p>The two real key differences are that we don&#39;t <code>apk add npm</code> and we&#39;re doing <code>COPY --from=my-node</code> which means we&#39;re copying from the first stage. We do <code>FROM node:20 AS node-builder</code> so we can refer to node-builder by name which simplifies reading the Dockerfile.</p>
<p>As you may imagine, this means you can copy from any previous stage or if you leave <code>--from</code> off it&#39;ll come from the host machine.</p>
<p>So try it now!</p>
<pre><code class="hljs language-bash">docker build -t my-multi .
docker run -it -p 8080:8080 --name my-app --<span class="hljs-built_in">rm</span> --init my-multi
</code></pre><p>Still works! And our container size is down to a cool 72MB as compared to 89MB when we included npm, 150MB when we used <code>node:20-alpine</code> and 1.1GB when we used <code>node:20</code>.</p>
<p>Pretty amazing, right? Honestly, how worth is it doing micro optimization like this? Not very. We had to do a decent amount to shave 50% off the final size and now we&#39;re stuck maintaining it. I&#39;d rather just start with <code>FROM node:20-alpine</code> and call it a day. We get all their wisdom for free and we&#39;re not stuck with a longer Dockerfile than we need. But it is definitely worth going from 1.1GB to 150MB!</p>
<h2>A note on container sizes</h2>
<p>A last note here: file size isn&#39;t everything. It&#39;s at best weakly correlated with security, it&#39;s just a fun metric to measure. In theory you&#39;ll save some money on bandwidth but I have to guess you&#39;ll spend more engineering salaries making containers tiny than you&#39;ll save on bandwidth. I&#39;d much rather have <code>node:20</code> and have it be maintained by security professionals than trying to do it myself. Just keep that in mind: it can be a fool&#39;s errand to chase shaving bytes off your containers.</p>
</div><div class="lesson-links"><a href="/lessons/making-tiny-containers/making-our-own-alpine-nodejs-container" class="prev">← Previous</a><a href="/lessons/making-tiny-containers/distroless" class="next">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="40" height="32" viewBox="0 0 40 32"><defs><clipPath id="clip-twitter-social"><rect width="40" height="32"></rect></clipPath></defs><g id="twitter-social" clip-path="url(#clip-twitter-social)"><g id="Group_269" data-name="Group 269" transform="translate(-230.23 -1140.849)"><path id="Path_419" data-name="Path 419" d="M266.12,1148.861v1.035a23.092,23.092,0,0,1-1.507,8.1,24.08,24.08,0,0,1-4.475,7.381,22.175,22.175,0,0,1-7.306,5.4,24.129,24.129,0,0,1-10,2.07,23.7,23.7,0,0,1-6.667-.945,22.83,22.83,0,0,1-5.936-2.655q.959.091,1.963.09a16.518,16.518,0,0,0,5.434-.9,17.111,17.111,0,0,0,4.749-2.52,8.275,8.275,0,0,1-4.749-1.643,7.8,7.8,0,0,1-2.877-3.983,8.268,8.268,0,0,0,1.507.135,8.58,8.58,0,0,0,2.146-.27,8.16,8.16,0,0,1-5.685-4.344,8.326,8.326,0,0,1-.89-3.578v-.135a7.775,7.775,0,0,0,3.744,1.035,8.183,8.183,0,0,1-2.671-2.9,7.817,7.817,0,0,1-.982-3.848,7.948,7.948,0,0,1,1.1-4.05,23.53,23.53,0,0,0,16.895,8.46,9.221,9.221,0,0,1-.183-1.845,7.787,7.787,0,0,1,1.1-4.05,8.216,8.216,0,0,1,2.991-2.948,7.991,7.991,0,0,1,4.087-1.1,8.184,8.184,0,0,1,5.982,2.566,16.087,16.087,0,0,0,5.205-1.98,7.784,7.784,0,0,1-1.393,2.588,8.4,8.4,0,0,1-2.215,1.913,16.856,16.856,0,0,0,4.749-1.305A17.032,17.032,0,0,1,266.12,1148.861Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Excercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul></footer></div><script async="" defer="" src="https://a.holt.courses/latest.js"></script><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"post":{"attributes":{"description":"Learn how to optimize Docker images using multistage builds with Node.js and Alpine, reducing container size significantly by eliminating unnecessary dependencies like npm. Follow a tutorial on building a Dockerfile with multiple stages and leveraging Alpine for smaller, more efficient containers.","keywords":["Docker multistage build","Node.js Alpine Docker image","optimize Docker image size"]},"html":"\u003cp\u003eHey, we\u0026#39;re already half-way to ridiculous, let\u0026#39;s make our image EVEN SMALLER. Technically we only need \u003ccode\u003enpm\u003c/code\u003e to build our app, right? We don\u0026#39;t actually need it to run our app. Docker allows you to have what it called multistage builds, we it uses one container to build your app and another to run it. This can be useful if you have big dependencies to build your app but you don\u0026#39;t need those dependencies to actually run the app. A C++ or Rust app might be a good example of that: they need big tool chains to compile the apps but the resulting binaries are smaller and don\u0026#39;t need those tools to actually run them. Or one perhaps more applicable to you is that you don\u0026#39;t need the TypeScript or Sass compiler in production, just the compiled files. We\u0026#39;ll actually do that here in a sec, but let\u0026#39;s start here with eliminating \u003ccode\u003enpm\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eMake a new Dockerfile, call it \u003ccode\u003eDockerfile\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-dockerfile\"\u003e\u003cspan class=\"hljs-comment\"\u003e# build stage\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e node:\u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e AS node-builder\n\u003cspan class=\"hljs-keyword\"\u003eRUN\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e /build\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eWORKDIR\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e /build\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOPY\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e package-lock.json package.json ./\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eRUN\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e npm ci\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOPY\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e . .\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# runtime stage\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e alpine:\u003cspan class=\"hljs-number\"\u003e3.19\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eRUN\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e apk add --update nodejs\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eRUN\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e addgroup -S node \u0026amp;\u0026amp; adduser -S node -G node\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eUSER\u003c/span\u003e node\n\u003cspan class=\"hljs-keyword\"\u003eRUN\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e /home/node/code\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eWORKDIR\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e /home/node/code\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOPY\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e --from=node-builder --\u003cspan class=\"hljs-built_in\"\u003echown\u003c/span\u003e=node:node /build .\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCMD\u003c/span\u003e\u003cspan class=\"language-bash\"\u003e [\u003cspan class=\"hljs-string\"\u003e\u0026quot;node\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;index.js\u0026quot;\u003c/span\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNotice we have have two \u003ccode\u003eFROM\u003c/code\u003e instructions. This is how you can tell it\u0026#39;s multistage. The last container made will be the final one that gets labeled and shipped. Notice we\u0026#39;re starting in the full \u003ccode\u003enode:20\u003c/code\u003e container since we\u0026#39;re not going to ship this container so we can use the kitchen sink to build it before it copying it to a smaller container.\u003c/p\u003e\n\u003cp\u003eAfter building everything in the build stage (you can have more than two stages by the way) we move on to the runtime container. In this one we\u0026#39;re using Alpine due its size and security benefits. Everything else looks similar to what we were doing before, just now we\u0026#39;re going to be copying from the build container instead of the host machine.\u003c/p\u003e\n\u003cp\u003eThe two real key differences are that we don\u0026#39;t \u003ccode\u003eapk add npm\u003c/code\u003e and we\u0026#39;re doing \u003ccode\u003eCOPY --from=my-node\u003c/code\u003e which means we\u0026#39;re copying from the first stage. We do \u003ccode\u003eFROM node:20 AS node-builder\u003c/code\u003e so we can refer to node-builder by name which simplifies reading the Dockerfile.\u003c/p\u003e\n\u003cp\u003eAs you may imagine, this means you can copy from any previous stage or if you leave \u003ccode\u003e--from\u003c/code\u003e off it\u0026#39;ll come from the host machine.\u003c/p\u003e\n\u003cp\u003eSo try it now!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edocker build -t my-multi .\ndocker run -it -p 8080:8080 --name my-app --\u003cspan class=\"hljs-built_in\"\u003erm\u003c/span\u003e --init my-multi\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eStill works! And our container size is down to a cool 72MB as compared to 89MB when we included npm, 150MB when we used \u003ccode\u003enode:20-alpine\u003c/code\u003e and 1.1GB when we used \u003ccode\u003enode:20\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003ePretty amazing, right? Honestly, how worth is it doing micro optimization like this? Not very. We had to do a decent amount to shave 50% off the final size and now we\u0026#39;re stuck maintaining it. I\u0026#39;d rather just start with \u003ccode\u003eFROM node:20-alpine\u003c/code\u003e and call it a day. We get all their wisdom for free and we\u0026#39;re not stuck with a longer Dockerfile than we need. But it is definitely worth going from 1.1GB to 150MB!\u003c/p\u003e\n\u003ch2\u003eA note on container sizes\u003c/h2\u003e\n\u003cp\u003eA last note here: file size isn\u0026#39;t everything. It\u0026#39;s at best weakly correlated with security, it\u0026#39;s just a fun metric to measure. In theory you\u0026#39;ll save some money on bandwidth but I have to guess you\u0026#39;ll spend more engineering salaries making containers tiny than you\u0026#39;ll save on bandwidth. I\u0026#39;d much rather have \u003ccode\u003enode:20\u003c/code\u003e and have it be maintained by security professionals than trying to do it myself. Just keep that in mind: it can be a fool\u0026#39;s errand to chase shaving bytes off your containers.\u003c/p\u003e\n","markdown":"\nHey, we're already half-way to ridiculous, let's make our image EVEN SMALLER. Technically we only need `npm` to build our app, right? We don't actually need it to run our app. Docker allows you to have what it called multistage builds, we it uses one container to build your app and another to run it. This can be useful if you have big dependencies to build your app but you don't need those dependencies to actually run the app. A C++ or Rust app might be a good example of that: they need big tool chains to compile the apps but the resulting binaries are smaller and don't need those tools to actually run them. Or one perhaps more applicable to you is that you don't need the TypeScript or Sass compiler in production, just the compiled files. We'll actually do that here in a sec, but let's start here with eliminating `npm`.\n\nMake a new Dockerfile, call it `Dockerfile`.\n\n```dockerfile\n# build stage\nFROM node:20 AS node-builder\nRUN mkdir /build\nWORKDIR /build\nCOPY package-lock.json package.json ./\nRUN npm ci\nCOPY . .\n\n# runtime stage\nFROM alpine:3.19\nRUN apk add --update nodejs\nRUN addgroup -S node \u0026\u0026 adduser -S node -G node\nUSER node\nRUN mkdir /home/node/code\nWORKDIR /home/node/code\nCOPY --from=node-builder --chown=node:node /build .\nCMD [\"node\", \"index.js\"]\n```\n\nNotice we have have two `FROM` instructions. This is how you can tell it's multistage. The last container made will be the final one that gets labeled and shipped. Notice we're starting in the full `node:20` container since we're not going to ship this container so we can use the kitchen sink to build it before it copying it to a smaller container.\n\nAfter building everything in the build stage (you can have more than two stages by the way) we move on to the runtime container. In this one we're using Alpine due its size and security benefits. Everything else looks similar to what we were doing before, just now we're going to be copying from the build container instead of the host machine.\n\nThe two real key differences are that we don't `apk add npm` and we're doing `COPY --from=my-node` which means we're copying from the first stage. We do `FROM node:20 AS node-builder` so we can refer to node-builder by name which simplifies reading the Dockerfile.\n\nAs you may imagine, this means you can copy from any previous stage or if you leave `--from` off it'll come from the host machine.\n\nSo try it now!\n\n```bash\ndocker build -t my-multi .\ndocker run -it -p 8080:8080 --name my-app --rm --init my-multi\n```\n\nStill works! And our container size is down to a cool 72MB as compared to 89MB when we included npm, 150MB when we used `node:20-alpine` and 1.1GB when we used `node:20`.\n\nPretty amazing, right? Honestly, how worth is it doing micro optimization like this? Not very. We had to do a decent amount to shave 50% off the final size and now we're stuck maintaining it. I'd rather just start with `FROM node:20-alpine` and call it a day. We get all their wisdom for free and we're not stuck with a longer Dockerfile than we need. But it is definitely worth going from 1.1GB to 150MB!\n\n## A note on container sizes\n\nA last note here: file size isn't everything. It's at best weakly correlated with security, it's just a fun metric to measure. In theory you'll save some money on bandwidth but I have to guess you'll spend more engineering salaries making containers tiny than you'll save on bandwidth. I'd much rather have `node:20` and have it be maintained by security professionals than trying to do it myself. Just keep that in mind: it can be a fool's errand to chase shaving bytes off your containers.\n","slug":"multi-stage-builds","title":"Multi Stage Builds","section":"Making Tiny Containers","icon":"minimize","filePath":"/home/runner/work/complete-intro-to-containers-v2/complete-intro-to-containers-v2/lessons/05-making-tiny-containers/C-multi-stage-builds.md","nextSlug":"/lessons/making-tiny-containers/distroless","prevSlug":"/lessons/making-tiny-containers/making-our-own-alpine-nodejs-container"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"making-tiny-containers","slug":"multi-stage-builds"},"buildId":"nARcRKX1ZlcrYUdSUSS9z","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>